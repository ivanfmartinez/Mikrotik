# Number of backup files to keep
# Each backup will generate 2 files (.backup and .rsc)
:global BkMaxFiles
:global BkExportOptions
if ([:len $BkMaxFiles] = 0) do={
 	:global BkMaxFiles 10
}
if ([:len $BkExportOptions] = 0) do={
# As the export is not protected by password does not include passwords
 	:global BkExportOptions "hide-sensitive"
}

##USE_FUNCTION ISODateTime
##USE_FUNCTION SafeFileName
##USE_FUNCTION FlashPrefix
##USE_FUNCTION SortList
##USE_FUNCTION RemoveOldFiles

# Compare only the digits in the values... AS the digits are an timestamp will work fine
:global SortListCompareValues do={
##USE_FUNCTION DigitsOnly

    :return ([:tonum [$DigitsOnly $1]] < [:tonum [$DigitsOnly $2]]);
}

:local backupId [$SafeFileName ([/system identity get name] . "-" . [/system resource get version ] . "-" . [$ISODateTime] . "-" . [/system clock get time-zone-name ]) ]
:local backupFN [$FlashPrefix ("bk-" . $backupId) ]

[$RemoveOldFiles "bk-*" $BkMaxFiles]

/system backup save name="$backupFN"
:execute "/export $BkExportOptions file=\"$backupFN\"" 

